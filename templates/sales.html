{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Sales Management</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSaleModal">
        <i class="fas fa-plus"></i> Create Sales Order
    </button>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Invoice #</th>
                <th>Customer</th>
                <th>Sales Person</th>
                <th>Date</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales %}
            <tr>
                <td>{{ sale.invoice_number }}</td>
                <td>{{ sale.customer.name if sale.customer else 'N/A' }}</td>
                <td>{{ sale.employee.name if sale.employee else 'N/A' }}</td>
                <td>{{ sale.sale_date.strftime('%Y-%m-%d') if sale.sale_date else 'N/A' }}</td>
                <td>{{ format_currency(sale.total_amount) }}</td>
                <td>
                    <span class="badge bg-{{ 'success' if sale.status == 'completed' else 'warning' }}">
                        {{ sale.status }}
                    </span>
                </td>
                <td>
                    {% if sale.status == 'pending' %}
                    <a href="{{ url_for('complete_sale', sale_id=sale.id) }}" class="btn btn-sm btn-outline-success" onclick="return confirm('Mark this sale as completed?')">
                        <i class="fas fa-check"></i> Complete
                    </a>
                    {% endif %}
                    {% if not sale.tally_synced %}
                    <span class="badge bg-warning">Not Synced</span>
                    {% else %}
                    <span class="badge bg-success">Synced</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Sale Modal -->
<div class="modal fade" id="addSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Sales Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_sale') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Customer</label>
                                <select class="form-control" name="customer_id" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sales Person</label>
                                <select class="form-control" name="employee_id" required>
                                    <option value="">Select Employee</option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.id }}">{{ employee.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Items</label>
                        <div id="items-container">
                            <div class="row mb-2">
                                <div class="col-md-4">
                                    <select class="form-control" name="item_id[]" required>
                                        <option value="">Select Item</option>
                                        {% for item in items %}
                                        <option value="{{ item.id }}" data-price="{{ item.selling_price }}">{{ item.name }} (Stock: {{ item.current_stock }})</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" step="0.01" class="form-control" name="quantity[]" placeholder="Qty" required>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control" name="assigned_employee[]" required>
                                        <option value="">Assign To</option>
                                        {% for employee in employees %}
                                        <option value="{{ employee.id }}">{{ employee.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm remove-item"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="add-item-btn">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Discount (â‚¹)</label>
                        <input type="number" step="0.01" class="form-control" name="discount" value="0">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Sales Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.getElementById('add-item-btn').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2';
    newRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-control" name="item_id[]" required>
                <option value="">Select Item</option>
                {% for item in items %}
                <option value="{{ item.id }}" data-price="{{ item.selling_price }}">{{ item.name }} (Stock: {{ item.current_stock }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" step="0.01" class="form-control" name="quantity[]" placeholder="Qty" required>
        </div>
        <div class="col-md-4">
            <select class="form-control" name="assigned_employee[]" required>
                <option value="">Assign To</option>
                {% for employee in employees %}
                <option value="{{ employee.id }}">{{ employee.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm remove-item"><i class="fas fa-times"></i></button>
        </div>
    `;
    container.appendChild(newRow);
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-item')) {
        e.target.closest('.row').remove();
    }
});
</script>
{% endblock %}
{% endblock %}